<!DOCTYPE html>
<html lang="en-us">
<head>
<base href="https://cdn.jsdelivr.net/gh/aukak/hollow-knight@latest/">
<meta charset="utf-8">
<title>Hollow Knight</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #000; overflow: hidden; }
  #loading-status { 
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%); 
    color: #fff; font: 18px Arial; 
  }
  #unity-canvas { width: 100vw; height: 100vh; display: block; }
  .savebtn { 
    position: fixed; top: 12px; right: 12px; padding: 10px 18px; 
    cursor: pointer; background: rgba(50,50,50,0.8); color: #fff; 
    border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; 
    font: 14px Arial; z-index: 9999; 
  }
</style>
</head>
<body>

<div id="loading-status">Loading...</div>
<canvas id="unity-canvas"></canvas>

<script>
let lb = 0;
const lt = document.getElementById("loading-status");
const cv = document.getElementById("unity-canvas");
const totalMB = '912.81';

// Progress Fetcher
async function fwp(u) {
  const r = await fetch(u);
  const rd = r.body.getReader();
  const ch = [];
  while (true) {
    const {done, value} = await rd.read();
    if (done) break;
    lb += value.length;
    ch.push(value);
    lt.textContent = `Loading: ${(lb / 1048576).toFixed(2)} MB / ${totalMB} MB`;
  }
  return URL.createObjectURL(new Blob(ch));
}

async function mf(p) {
  const b = await Promise.all(p.map(fwp));
  const bl = await Promise.all(b.map(u => fetch(u).then(r => r.blob())));
  return URL.createObjectURL(new Blob(bl));
}

function gp(f, s, e) {
  return Array.from({length: e - s + 1}, (_, i) => `${f}.part${s + i}`);
}

(async () => {
  try {
    const [du, wu] = await Promise.all([
      mf(gp("Build/hktruffled.data", 1, 45)),
      mf(gp("Build/hktruffled.wasm", 1, 2))
    ]);
    
    const sc = document.createElement("script");
    sc.src = "Build/hktruffled.loader.js";
    sc.onload = () => {
      createUnityInstance(cv, {
        dataUrl: du,
        frameworkUrl: "Build/hktruffled.framework.js",
        codeUrl: wu,
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Team Cherry",
        productName: "Hollow Knight",
        productVersion: "1.0"
      }).then(() => {
        lt.remove();
        asb();
      });
    };
    document.body.appendChild(sc);
  } catch (e) {
    console.error("Initialization failed", e);
  }
})();

// Save Management
function asb() {
  const sb = document.createElement('button');
  sb.className = 'savebtn';
  sb.textContent = 'Backup Save';
  sb.onclick = sdl;
  document.body.appendChild(sb);
}

async function sdl() {
  try {
    const dbs = await indexedDB.databases();
    let sv = {}, fd = false;
    for (const inf of dbs) {
      const db = await new Promise((ok, bd) => {
        const r = indexedDB.open(inf.name);
        r.onsuccess = () => ok(r.result);
        r.onerror = () => bd(r.error);
      });
      
      for (const st of db.objectStoreNames) {
        const dt = await new Promise((ok, bd) => {
          const t = db.transaction([st], 'readonly');
          const r = t.objectStore(st).getAll();
          r.onsuccess = () => ok(r.result);
          r.onerror = () => bd(r.error);
        });
        
        if (dt && dt.length > 0) {
          sv[`${inf.name}/${st}`] = dt.map(it => {
            if (it.contents && it.contents instanceof Uint8Array) {
              return { ...it, contents: Array.from(it.contents) };
            }
            return it;
          });
          fd = true;
        }
      }
      db.close();
    }
    if (!fd) return;
    const bl = new Blob([JSON.stringify(sv)], { type: 'application/octet-stream' });
    const u = URL.createObjectURL(bl);
    const a = document.createElement('a');
    a.href = u;
    a.download = 'hk_save.dat';
    a.click();
    URL.revokeObjectURL(u);
  } catch (e) {
    console.error('Download failed', e);
  }
}
</script>
</body>
</html>
